/*
 *	Scopewriter : Popular Electronics August 1974
 *	https://worldradiohistory.com/Popular-Electronics-Guide.htm
 *
 *	This was originally entertaining electronics trick where bytes
 *	were toggled in with switches but could instead be attached to
 *	a serial interface
 */

#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#include "scopewriter.h"

struct scopewriter
{
    uint8_t mem[32];
    uint8_t ptr;
    uint8_t data;
    uint8_t switches;
    /* Fudged for now */
    uint32_t raster[256 * 32];
};


/* Not the right font - the real one is 5x7 but this will do for the moment */

static const uint8_t sw_font[] = {
/* 00 */
	0x3E,0x41,0x41,0x4D,0x55,0x5E,0x40,0x40,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 01 */
	0x1C,0x22,0x41,0x41,0x7F,0x41,0x41,0x41,0x41,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 02 */
	0x7E,0x21,0x21,0x21,0x3E,0x21,0x21,0x21,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 03 */
	0x1E,0x21,0x40,0x40,0x40,0x40,0x40,0x21,0x1E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 04 */
	0x7E,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 05 */
	0x7F,0x40,0x40,0x40,0x78,0x40,0x40,0x40,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 06 */
	0x7F,0x40,0x40,0x40,0x78,0x40,0x40,0x40,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 07 */
	0x1E,0x21,0x40,0x40,0x40,0x47,0x41,0x21,0x1E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 08 */
	0x41,0x41,0x41,0x41,0x7F,0x41,0x41,0x41,0x41,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 09 */
	0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 0A */
	0x1F,0x04,0x04,0x04,0x04,0x04,0x04,0x44,0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 0B */
	0x41,0x42,0x44,0x48,0x70,0x48,0x44,0x42,0x41,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 0C */
	0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 0D */
	0x41,0x63,0x55,0x49,0x49,0x41,0x41,0x41,0x41,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 0E */
	0x41,0x61,0x51,0x49,0x45,0x43,0x41,0x41,0x41,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 0F */
	0x1C,0x22,0x41,0x41,0x41,0x41,0x41,0x22,0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 10 */
	0x7E,0x41,0x41,0x41,0x7E,0x40,0x40,0x40,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 11 */
	0x1C,0x22,0x41,0x41,0x41,0x41,0x45,0x22,0x1D,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 12 */
	0x7E,0x41,0x41,0x41,0x7E,0x48,0x44,0x42,0x41,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 13 */
	0x3E,0x41,0x40,0x40,0x3E,0x01,0x01,0x41,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 14 */
	0x7F,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 15 */
	0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 16 */
	0x41,0x41,0x41,0x41,0x41,0x41,0x22,0x14,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 17 */
	0x41,0x41,0x41,0x49,0x49,0x49,0x55,0x63,0x41,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 18 */
	0x41,0x41,0x22,0x14,0x08,0x14,0x22,0x41,0x41,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 19 */
	0x41,0x41,0x22,0x14,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 1A */
	0x7F,0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 1B */
	0x1E,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x1E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 1C */
	0x00,0x40,0x20,0x10,0x08,0x04,0x02,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 1D */
	0x3C,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x3C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 1E */
	0x3E,0x41,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 1F */
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 20 */
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 21 */
	0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 22 */
	0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 23 */
	0x14,0x14,0x14,0x7F,0x14,0x7F,0x14,0x14,0x14,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 24 */
	0x08,0x3F,0x48,0x48,0x3E,0x09,0x09,0x7E,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 25 */
	0x20,0x51,0x22,0x04,0x08,0x10,0x22,0x45,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 26 */
	0x38,0x44,0x44,0x28,0x10,0x29,0x46,0x46,0x39,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 27 */
	0x20,0x20,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 28 */
	0x08,0x10,0x20,0x20,0x20,0x20,0x20,0x10,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 29 */
	0x08,0x04,0x02,0x02,0x02,0x02,0x02,0x04,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 2A */
	0x08,0x49,0x2A,0x1C,0x7F,0x1C,0x2A,0x49,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 2B */
	0x00,0x08,0x08,0x08,0x7F,0x08,0x08,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 2C */
	0x00,0x00,0x00,0x00,0x00,0x30,0x10,0x10,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 2D */
	0x00,0x00,0x00,0x00,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 2E */
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 2F */
	0x00,0x01,0x02,0x04,0x08,0x10,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 30 */
	0x3E,0x41,0x43,0x45,0x49,0x51,0x61,0x41,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 31 */
	0x08,0x18,0x08,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 32 */
	0x3E,0x41,0x01,0x02,0x0C,0x10,0x20,0x40,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 33 */
	0x3E,0x41,0x01,0x01,0x1E,0x01,0x01,0x41,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 34 */
	0x02,0x06,0x0A,0x12,0x22,0x7F,0x02,0x02,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 35 */
	0x7F,0x40,0x40,0x40,0x7E,0x01,0x01,0x41,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 36 */
	0x3E,0x41,0x40,0x40,0x7E,0x41,0x41,0x41,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 37 */
	0x7F,0x41,0x02,0x04,0x08,0x10,0x10,0x10,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 38 */
	0x3E,0x41,0x41,0x41,0x3E,0x41,0x41,0x41,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 39 */
	0x3F,0x41,0x41,0x41,0x3F,0x01,0x01,0x41,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 3A */
	0x00,0x00,0x20,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 3B */
	0x20,0x00,0x00,0x00,0x00,0x30,0x10,0x10,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 3C */
	0x04,0x08,0x10,0x20,0x40,0x20,0x10,0x08,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 3D */
	0x00,0x00,0x00,0x7F,0x00,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 3E */
	0x10,0x08,0x04,0x02,0x01,0x02,0x04,0x08,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* 3F */
	0x3E,0x41,0x41,0x02,0x04,0x08,0x08,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

/* We should really raster at a higher resolution with a slope and with a 
   decaying upward trace on clear pixels */

static void sw_raster(struct scopewriter *sw, unsigned pos, uint8_t c)
{
    const uint8_t *fontptr = sw_font + 16 * (c & 0x3F);
    uint32_t *rptr = sw->raster + (pos << 3);
    unsigned int x,y;
    uint8_t bits;
    uint32_t deltamod;

    for (y = 0; y < 16; y++) {
        for (x = 0; x < 8; x++)
            *rptr++ = 0xFF224422;
        rptr += 248;
    }
    for (y = 0; y < 16; y++) {
        bits = *fontptr++;
        for (x = 0; x < 8; x++) {
            if (bits & 0x80)
                *rptr++ = 0xFF66CC66;
            else
                *rptr++ = 0xFF224422;
            bits <<= 1;
        }
        rptr += 248;	/* We moved on 8 in the loop */
    }

    for (x = 0; x < 8; x++) {
        deltamod = 0x00000000;
        rptr = sw->raster + (pos << 3) + x + 31 * 256;
        for (y = 0; y < 32; y++) {
            if (((*rptr >> 8) & 0xFF) >= 0xCC)
                deltamod += 0x00000200;
            *rptr += deltamod;
            if (y == 16 + ((((pos << 3) + x) * 17) & 3))
                deltamod += deltamod;
            if (y == 24 + ((((pos << 3) + x) * 13) & 3))
                deltamod += deltamod;
            rptr -= 256;
        }
    }
}

static void sw_data_update(struct scopewriter *sw)
{
    if (sw->switches & SW_RD)
        return;
    /* This next bit really hasppens with the sweep not instantly but this
       will do for the moment TODO */
    if (!(sw->switches & SW_PB))
        memset(sw->mem, sw->data, 32);
    else
        sw->mem[sw->ptr] = sw->data;
}

void scopewriter_write(struct scopewriter *sw, uint8_t byte)
{
    sw->data = byte;
    sw_data_update(sw);
}


/* There are three controls

    S1 is PB or OSC
    S2 is LOAD
    S3 is WR/RE
    
    To program it PB/OSC is set to OSC, WR/RE is set to WR, PB/OSC to PB
    each byte is then loaded and LOAD is pressed, then S3 is set to RE and
    PB/OSC is set ot OSC to display
    
    When PB is set to PB the byte at the pointer position is rastered 32 times
    otherwise the line is swept. When WR is set nothing is output
 */

void scopewriter_switches(struct scopewriter *sw, uint8_t bit, uint8_t val)
{
    uint8_t delta;
    uint8_t switches = sw->switches & ~bit;
    if (val)
    	switches |= bit;

    delta = sw->switches ^ switches;
    /* Really this is a hex 32bit shift register (TMS3112NC) */
    if (delta & SW_LOAD & switches) {
        sw->ptr++;
        sw->ptr &= 31;
    }
    sw->switches = switches;
}

uint32_t *scopewriter_get_raster(struct scopewriter *sw)
{
    unsigned int i;
    uint8_t byte;

    sw_data_update(sw);

    for (i = 0; i < 32; i++) {
        if (sw->switches & SW_PB)
            byte = sw->mem[sw->ptr];
        else
            byte = sw->mem[i];
        sw_raster(sw, i, byte & 0x3F);
    }
    return sw->raster;
}

struct scopewriter *scopewriter_create(void)
{
    struct scopewriter *sw = malloc(sizeof(struct scopewriter));

    if (sw == NULL) {
        fprintf(stderr, "Out of memory.\n");
        exit(1);
    }
    sw->ptr = 0;
    sw->data = 'A';
    sw->switches = SW_RD;
    sw_data_update(sw);
    scopewriter_get_raster(sw);
    return sw;
}

void scopewriter_free(struct scopewriter *sw)
{
    free(sw);
}
